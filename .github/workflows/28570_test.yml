name: 28570 Test

on:
  push:
    branches: [main]

jobs:
  preveri-teste:
    runs-on: self-hosted
    outputs:
      testi-obstajajo: ${{ steps.preveri.outputs.obstajajo }}

    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Preveri testne skripte
        id: preveri
        run: |
          if [ -d "tests" ] && [ -f "tests/test1.txt" ]; then
            echo "Testne skripte obstajajo."
            echo "obstajajo=true" >> $GITHUB_OUTPUT
          else
            echo "napaka: Testne skripte manjkajo." > napaka.txt
            echo "obstajajo=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Shranjevanje napake
        if: steps.preveri.outputs.obstajajo == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: napaka
          path: napaka.txt

  izvajanje-testov:
    needs: preveri-teste
    if: needs.preveri-teste.outputs.testi-obstajajo == 'true'
    runs-on: self-hosted
    strategy:
      matrix:
        algoritem: [0, 1]
        vzorec: ["abc", "test"]
        vhod: ["tests/test1.txt"]

    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Namesti orodja
        run:  sudo apt update -qq && sudo apt install -y --no-install-recommends g++

      - name: Prevedi program
        run: g++ -o algoritmi main.cpp

      - name: Zazeni test
        run: |
          ./algoritmi "${{ matrix.algoritem }}" "${{ matrix.vzorec }}" "${{ matrix.vhod }}"
          echo "Rezultat testa: alg=${{ matrix.algoritem }}, vzorec=${{ matrix.vzorec }}"
          cat out.txt